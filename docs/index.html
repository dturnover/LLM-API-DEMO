<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LLM API Demo</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:820px;margin:24px auto;padding:0 16px}
    #log{white-space:pre-wrap;border:1px solid #ddd;border-radius:12px;padding:12px;min-height:180px}
    textarea{width:100%;padding:10px}
    button{padding:8px 14px}
    .row{display:flex;gap:8px;margin-top:10px;align-items:flex-start}
    .tiny{font-size:12px;color:#666}
    label{user-select:none}
  </style>
</head>
<body>
  <h2>LLM API Demo</h2>
  <div id="log"></div>
  <div class="row">
    <textarea id="msg" rows="3" placeholder="Type your message..."></textarea>
    <div>
      <button id="send">Send</button>
      <div class="tiny"><label><input type="checkbox" id="useSSE"> try streaming (experimental)</label></div>
    </div>
  </div>

<script>
const API = "https://llm-api-demo-5qz1.onrender.com"; // backend
const log = document.getElementById('log');
const msg = document.getElementById('msg');
const btn = document.getElementById('send');
const useSSE = document.getElementById('useSSE');

function append(t){ log.textContent += t; log.scrollTop = log.scrollHeight; }
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

async function wake() {
  // Wake free Render dyno (CF can 503 until app is hot)
  for (let i=0;i<40;i++){
    try { const r = await fetch(API+'/', { credentials:'include' }); if (r.ok) return; } catch {}
    await sleep(3000);
  }
}

async function sendJSON(message){
  await wake();
  const r = await fetch(API+'/chat', {
    method:'POST',
    credentials:'include',       // keep cookie sid
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ message })
  });
  if (!r.ok) throw new Error('HTTP '+r.status);
  return r.json();               // {response, sources, selected_corpus, remembered}
}

// Optional streaming (infra-dependent; may fail on free tier)
// Uses GET so no POST body gets dropped by proxies.
function stream(message){
  const url = API + '/chat_sse_get?q=' + encodeURIComponent(message);
  const es = new EventSource(url, { withCredentials:true });
  es.onopen = () => append(': connected\n');
  es.onmessage = (e) => { if (e.data !== '[DONE]') append(e.data); };
  es.addEventListener('done', () => es.close());
  es.onerror = () => es.close();
  return es;
}

async function send(){
  const text = msg.value.trim(); if (!text) return;
  msg.value = "";
  append(`You: ${text}\n\nBot: `);
  try{
    if (useSSE.checked) {
      // Best-effort streaming (may show nothing on free tier)
      stream(text);
      append('\n'); // leave line for tokens
    } else {
      const data = await sendJSON(text);
      append(data.response + "\n\n");
    }
  }catch(e){
    append(`[network error: ${e.message}]\n\n`);
  }
}

btn.onclick = send;
msg.addEventListener('keydown', (e) => {
  if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); }
});
</script>
</body>
</html>
