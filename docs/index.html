<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LLM API Demo</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:820px;margin:24px auto;padding:0 16px}
    #log{white-space:pre-wrap;border:1px solid #ddd;border-radius:12px;padding:12px;min-height:180px}
    textarea{width:100%;padding:10px} button{padding:8px 14px}
    .row{display:flex;gap:8px;margin-top:10px;align-items:flex-start}.tiny{font-size:12px;color:#666}
  </style>
</head>
<body>
  <h2>LLM API Demo</h2>
  <div id="log"></div>
  <div class="row">
    <textarea id="msg" rows="3" placeholder="Type your message..."></textarea>
    <div>
      <button id="send">Send</button>
      <div class="tiny"><label><input type="checkbox" id="useSSE" checked> stream</label></div>
    </div>
  </div>
<script>
const API = "https://llm-api-demo-5qz1.onrender.com";
const ORIGIN = "https://dturnover.github.io"; // for reference only

const log = document.getElementById('log');
const msg = document.getElementById('msg');
const sendBtn = document.getElementById('send');
const streamChk = document.getElementById('stream');

function append(t){ log.textContent += t; log.scrollTop = log.scrollHeight; }

async function streamPost(message){
  // POST to /chat_sse and read the response body stream
  const res = await fetch(`${API}/chat_sse`, {
    method: "POST",
    credentials: "include",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message })
  });
  if (!res.ok || !res.body) throw new Error(`status ${res.status}`);
  const reader = res.body.getReader();
  const decoder = new TextDecoder();

  // SSE frames are lines that start with "data:" or "event:"
  let carry = "";
  while (true) {
    const { value, done } = await reader.read();
    if (done) break;
    carry += decoder.decode(value, { stream: true });
    let idx;
    while ((idx = carry.indexOf("\n")) >= 0) {
      const line = carry.slice(0, idx).trimEnd();
      carry = carry.slice(idx + 1);
      if (!line) continue;              // blank line between events
      if (line.startsWith(":")) continue; // comments like ": connected"
      if (line.startsWith("data:")) {
        append(line.slice(5).trimStart());
      } else if (line.startsWith("event:")) {
        // optional: you can watch for "sources" / "done" etc.
      }
    }
  }
  append("\n");
}

async function send(){
  const text = msg.value.trim(); if (!text) return;
  msg.value = "";
  append(`You: ${text}\n\nBot: `);

  try {
    if (streamChk.checked) {
      // Use POST streaming instead of GET + EventSource
      await streamPost(text);
    } else {
      // Fallback: JSON (non-stream)
      const r = await fetch(`${API}/chat`, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      });
      const j = await r.json();
      append(j.response + "\n\n");
    }
  } catch (e) {
    append(`[stream error] ${e.message}\n\n`);
  }
}

sendBtn.addEventListener('click', send);
msg.addEventListener('keydown', (e)=>{ if (e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); }});
console.log("frontend build: POST-stream");
</script>

</body>
</html>
