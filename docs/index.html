<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LLM API Demo</title>
  <style>body{font-family:sans-serif;max-width:800px;margin:24px auto}#log{white-space:pre-wrap;border:1px solid #ddd;border-radius:10px;padding:12px;min-height:160px}</style>
</head>
<body>
  <h2>LLM API Demo</h2>
  <div id="log"></div>
  <div style="display:flex;gap:8px;margin-top:10px;">
    <textarea id="msg" rows="3" placeholder="Type your message..."></textarea>
    <button id="send">Send</button>
  </div>
<script>
const API="https://llm-api-demo-5qz1.onrender.com";
const log=document.getElementById('log'); const msg=document.getElementById('msg'); const btn=document.getElementById('send');
function append(t){ log.textContent+=t; log.scrollTop=log.scrollHeight; }
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
async function wake(){ for(let i=0;i<40;i++){ try{ const r=await fetch(API+'/',{credentials:'include'}); if(r.ok) return }catch{} await sleep(3000) } }

async function sendJSON(message){
  await wake();
  const r=await fetch(API+'/chat',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({message})});
  if(!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}

function stream(message){
  const es=new EventSource(API+'/chat_sse_get?q='+encodeURIComponent(message),{withCredentials:true});
  es.onmessage=e=>{ if(e.data!=='[DONE]') append(e.data); };
  es.addEventListener('done',()=>es.close());
  es.onerror=()=>es.close();
  return es;
}

async function send(){
  const text=msg.value.trim(); if(!text) return; msg.value="";
  append(`You: ${text}\n\nBot: `);
  try{
    // use JSON by default for reliability
    const data=await sendJSON(text);
    append(data.response+"\n\n");
    // or streaming:
    // stream(text);
  }catch(e){ append(`[network error: ${e.message}]\n\n`); }
}
btn.onclick=send; msg.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); send(); }});
</script>
</body>
</html>
