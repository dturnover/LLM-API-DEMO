<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LLM API Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:820px;margin:24px auto;padding:0 12px}
    #log{white-space:pre-wrap;border:1px solid #ddd;border-radius:12px;padding:12px;min-height:200px}
    textarea{width:100%;padding:10px}
    button{padding:8px 14px}
    .row{display:flex;gap:8px;align-items:flex-start;margin-top:10px}
    .tiny{font-size:12px;color:#666}
    .muted{opacity:.65}
  </style>
</head>
<body>
  <h2>LLM API Demo</h2>
  <div id="log"></div>
  <div class="row">
    <textarea id="msg" rows="2" placeholder="Type your message..."></textarea>
    <button id="send">Send</button>
  </div>
  <label class="tiny"><input type="checkbox" id="stream" checked> stream</label>

  <script>
  (() => {
    const API = "https://llm-api-demo-5qz1.onrender.com";
    const log = document.getElementById("log");
    const msgEl = document.getElementById("msg");
    const sendBtn = document.getElementById("send");
    const streamBox = document.getElementById("stream");

    const append = (role, text) => {
      log.textContent += `\n${role}: ${text}`;
      log.scrollTop = log.scrollHeight;
    };

    const setBusy = (b) => {
      sendBtn.disabled = b; msgEl.disabled = b;
      sendBtn.classList.toggle("muted", b);
    };

    async function send() {
      const msg = (msgEl.value || "").trim();
      if (!msg) return;
      append("You", msg);
      msgEl.value = "";

      const useStream = !!(streamBox && streamBox.checked);

      if (!useStream) {
        try {
          const r = await fetch(`${API}/chat`, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ message: msg }),
            credentials: "include",
          });
          const j = await r.json();
          append("Bot", j?.response ?? "[no response]");
        } catch (e) {
          append("Bot", `[network error] ${e?.message || e}`);
        }
        return;
      }

      // Streaming with fetch + SSE-style parsing
      setBusy(true);
      try {
        const res = await fetch(`${API}/chat_sse?q=${encodeURIComponent(msg)}`, {
          method: "GET",
          headers: { "Accept": "text/event-stream" },
          credentials: "include",
        });
        if (!res.ok || !res.body) {
          append("Bot", `[stream error] HTTP ${res.status}`);
          setBusy(false); return;
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });

          let idx;
          while ((idx = buffer.indexOf("\n\n")) >= 0) {
            const frame = buffer.slice(0, idx);
            buffer = buffer.slice(idx + 2);

            if (frame.startsWith(":")) continue; // comment/heartbeat
            if (frame.startsWith("event: done")) continue;

            const dataLines = frame.split("\n").filter(l => l.startsWith("data:"));
            for (const ln of dataLines) {
              const payload = ln.slice(5).trim();
              if (!payload) continue;
              try {
                const obj = JSON.parse(payload);
                if (obj.text) append("Bot", obj.text);
                if (obj.sources) append("Bot", "[sources received]");
              } catch {
                append("Bot", payload); // fallback if non-JSON
              }
            }
          }
        }
      } catch (e) {
        append("Bot", `[stream error] ${e?.message || e}`);
      } finally {
        setBusy(false);
      }
    }

    sendBtn.addEventListener("click", send);
    msgEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) send();
    });
  })();
  </script>
</body>
</html>
